<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…æ›¸è±ªè¯ç‰ˆï¼š32å¼µèˆ‡NPCå°æˆ°</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #2c3e50; color: #ecf0f1; padding: 20px; line-height: 1.6; }
        .container { max-width: 900px; margin: auto; background: #34495e; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1 { text-align: center; color: #f1c40f; }
        
        /* éŠæˆ²è³‡è¨Šå€ */
        .status-bar { display: flex; justify-content: space-around; background: #2c3e50; padding: 10px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #f1c40f; }
        
        /* ç©å®¶é¡¯ç¤ºå€ */
        .players-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .player-box { background: #5d6d7e; padding: 15px; border-radius: 10px; text-align: center; border: 3px solid transparent; position: relative; }
        .player-box.active { border-color: #f1c40f; box-shadow: 0 0 15px #f1c40f; }
        .player-box.is-out { opacity: 0.4; background: #34495e; text-decoration: line-through; }
        .player-box.protected { border-color: #2ecc71; }
        .player-box.protected::after { content: "ğŸ›¡ï¸ ä¾å¥³ä¿è­·"; display: block; font-size: 12px; color: #2ecc71; }

        /* æ‰‹ç‰ŒæŒ‰éˆ• */
        .hand-area { margin-top: 10px; }
        button { background: #e67e22; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 2px; font-weight: bold; }
        button:hover { background: #d35400; }
        button:disabled { background: #7f8c8d; cursor: not-allowed; }

        /* æ—¥èªŒå€ */
        #log { background: #1a252f; height: 200px; overflow-y: auto; padding: 15px; border-radius: 5px; font-size: 14px; border-left: 5px solid #f1c40f; }
        .log-msg { margin-bottom: 5px; border-bottom: 1px solid #2c3e50; padding-bottom: 2px; }
        .log-important { color: #f1c40f; font-weight: bold; }

        /* æ–¹å‘æŒ‡ç¤ºå™¨ */
        .direction-arrow { font-size: 24px; color: #f1c40f; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ’Œ æƒ…æ›¸è±ªè¯ç‰ˆ (32å¼µ)</h1>

    <div id="setup-view" style="text-align: center;">
        <p>è«‹è¼¸å…¥ç©å®¶äººæ•¸ (2-8äºº)ï¼š</p>
        <input type="number" id="playerNum" value="4" min="2" max="8" style="padding: 10px; border-radius: 5px; width: 60px;">
        <button onclick="initGame()">é€²å…¥çŒœæ‹³éšæ®µ</button>
    </div>

    <div id="game-view" style="display: none;">
        <div class="status-bar">
            <div>ç‰Œåº«å‰©é¤˜: <span id="deck-count">0</span></div>
            <div id="direction-text">æ–¹å‘: ğŸ•’ é †æ™‚é‡</div>
            <div id="turn-text" class="log-important">è¼ªåˆ°èª°...</div>
        </div>

        <div class="players-container" id="players-display"></div>
        
        <div id="log"></div>
    </div>
</div>

<script>
    // 1. åŸºæœ¬è¨­å®š
    const CARDS = [
        { v: 1, name: "è¡›å…µ", count: 10 }, { v: 2, name: "ç¥çˆ¶", count: 4 },
        { v: 3, name: "ç”·çˆµ", count: 4 }, { v: 4, name: "ä¾å¥³", count: 4 },
        { v: 5, name: "ç‹å­", count: 4 }, { v: 6, name: "åœ‹ç‹", count: 2 },
        { v: 7, name: "ä¼¯çˆµå¤«äºº", count: 2 }, { v: 8, name: "å…¬ä¸»", count: 2 }
    ];

    let deck = [], players = [], currentPlayer = 0, gameDir = 1; // 1: é †æ™‚é‡, -1: é€†æ™‚é‡
    let isGameOver = false;

    // 2. åˆå§‹åŒ–éŠæˆ²
    function initGame() {
        const num = parseInt(document.getElementById('playerNum').value);
        if (num < 2 || num > 8) return alert("äººæ•¸éœ€åœ¨ 2-8 ä¹‹é–“");

        // ç”Ÿæˆç‰Œåº«ä¸¦æ´—ç‰Œ
        deck = [];
        CARDS.forEach(c => { for(let i=0; i<c.count; i++) deck.push({...c}); });
        deck.sort(() => Math.random() - 0.5);

        // åˆå§‹åŒ–ç©å®¶
        players = [];
        for (let i = 0; i < num; i++) {
            players.push({
                id: i,
                name: i === 0 ? "æˆ‘" : `NPC ${i}`,
                hand: [deck.pop()],
                isOut: false,
                isProtected: false,
                isNPC: i !== 0
            });
        }

        document.getElementById('setup-view').style.display = 'none';
        document.getElementById('game-view').style.display = 'block';
        addLog("ğŸ² éŠæˆ²åˆå§‹åŒ–å®Œæˆï¼Œæº–å‚™çŒœæ‹³ï¼");
        startRPS();
    }

    // 3. çŒœæ‹³é‚è¼¯ (äºŒã€ä¸‰)
    function startRPS() {
        const winner = Math.floor(Math.random() * players.length);
        currentPlayer = winner;
        addLog(`<span class="log-important">ğŸ† ${players[winner].name} çŒœæ‹³è´äº†ï¼</span>`);

        if (players[winner].isNPC) {
            gameDir = Math.random() > 0.5 ? 1 : -1;
            addLog(`${players[winner].name} æ±ºå®šè¼ªæµæ–¹å‘ç‚ºï¼š${gameDir === 1 ? 'é †æ™‚é‡' : 'é€†æ™‚é‡'}`);
            startMainLoop();
        } else {
            addLog("ä½ æ˜¯è´å®¶ï¼Œè«‹æ±ºå®šæ–¹å‘ï¼š");
            let btnCW = document.createElement("button");
            btnCW.innerText = "é †æ™‚é‡";
            btnCW.onclick = () => { gameDir = 1; startMainLoop(); };
            let btnCCW = document.createElement("button");
            btnCCW.innerText = "é€†æ™‚é‡";
            btnCCW.onclick = () => { gameDir = -1; startMainLoop(); };
            document.getElementById('log').appendChild(btnCW);
            document.getElementById('log').appendChild(btnCCW);
        }
    }

    function startMainLoop() {
        updateUI();
        addLog("ğŸš€ éŠæˆ²æ­£å¼é–‹å§‹ï¼");
        processTurn();
    }

    // 4. è¼ªæµé‚è¼¯ (äº”ã€å…­ã€å…«)
    async function processTurn() {
        if (isGameOver) return;
        
        let p = players[currentPlayer];
        p.isProtected = false; // ä¾å¥³ä¿è­·æ¶ˆå¤±

        // æŠ½ç‰Œ (äº”)
        if (deck.length > 0) {
            let drawn = deck.pop();
            p.hand.push(drawn);
            addLog(`${p.name} æŠ½äº†ä¸€å¼µç‰Œã€‚`);
            
            // é›™å…¬ä¸»ç‰¹æ®Šå‹åˆ©æ¢ä»¶ (å…«ã€å…¬ä¸»è¦å‰‡)
            if (p.hand.filter(c => c.v === 8).length === 2) {
                addLog(`ğŸ‰ ${p.name} æŠ½åˆ°äº†å…©å¼µå…¬ä¸»ï¼é”æˆç‰¹æ®Šå‹åˆ©ï¼`, true);
                isGameOver = true;
                updateUI();
                return;
            }
        } else {
            checkWinner();
            return;
        }

        updateUI();

        if (p.isNPC) {
            await sleep(1500);
            npcAI(p);
        }
    }

    // 5. è§’è‰²åŠŸèƒ½åŸ·è¡Œ (ä¸ƒ)
    function playCard(pIdx, cIdx) {
        let p = players[pIdx];
        let card = p.hand.splice(cIdx, 1)[0];
        
        // ä¼¯çˆµå¤«äººæª¢æŸ¥ (ä¸ƒ)
        const hasLady = p.hand.some(c => c.v === 7) || card.v === 7;
        const hasRoyalty = p.hand.some(c => c.v === 5 || c.v === 6);
        if (hasRoyalty && card.v !== 7 && p.hand.some(c => c.v === 7)) {
            alert("æ ¹æ“šè¦å‰‡ï¼Œæ‰‹ä¸Šæœ‰ç‹å­/åœ‹ç‹æ™‚å¿…é ˆæ‰“å‡ºä¼¯çˆµå¤«äººï¼");
            p.hand.push(card); // æ­¸é‚„
            return;
        }

        addLog(`${p.name} æ‰“å‡ºäº† [${card.name}]`);

        // åŠŸèƒ½é‚è¼¯
        switch (card.v) {
            case 1: // è¡›å…µ
                handleGuard(pIdx); break;
            case 2: // ç¥çˆ¶
                handlePriest(pIdx); break;
            case 3: // ç”·çˆµ
                handleBaron(pIdx); break;
            case 4: // ä¾å¥³
                p.isProtected = true; addLog(`${p.name} æœ¬å›åˆç„¡æ•µã€‚`); break;
            case 5: // ç‹å­
                handlePrince(pIdx); break;
            case 6: // åœ‹ç‹
                handleKing(pIdx); break;
            case 8: // å…¬ä¸»
                p.isOut = true; addLog(`ğŸ˜± ${p.name} æ£„æ‰äº†å…¬ä¸»ï¼Œå‡ºå±€ï¼`); break;
        }

        checkGameStatus();
        if (!isGameOver) {
            currentPlayer = (currentPlayer + gameDir + players.length) % players.length;
            while (players[currentPlayer].isOut) {
                currentPlayer = (currentPlayer + gameDir + players.length) % players.length;
            }
            setTimeout(processTurn, 1000);
        }
    }

    // 6. å…·é«”åŠŸèƒ½å¯¦ä½œ
    function handleGuard(meIdx) {
        let targetIdx = getTarget(meIdx);
        if (targetIdx === null) return addLog("ç„¡æ•ˆç›®æ¨™ã€‚");
        let guess = players[meIdx].isNPC ? Math.floor(Math.random()*7)+2 : prompt("çŒœä¸€å€‹èº«ä»½(2-8):");
        if (players[targetIdx].hand[0].v == guess) {
            addLog(`ğŸ¯ çŒœä¸­äº†ï¼${players[targetIdx].name} å‡ºå±€ï¼`);
            players[targetIdx].isOut = true;
        } else {
            addLog(`ğŸ’¨ çŒœéŒ¯äº†ã€‚`);
        }
    }

    function handleBaron(meIdx) {
        let tIdx = getTarget(meIdx);
        if (tIdx === null) return;
        addLog(`${players[meIdx].name} èˆ‡ ${players[tIdx].name} ç§ä¸‹æ¯”ç‰Œ...`);
        let v1 = players[meIdx].hand[0].v;
        let v2 = players[tIdx].hand[0].v;
        if (v1 > v2) { players[tIdx].isOut = true; addLog(`${players[tIdx].name} é»æ•¸è¼ƒå°ï¼Œå‡ºå±€ï¼`); }
        else if (v1 < v2) { players[meIdx].isOut = true; addLog(`${players[meIdx].name} é»æ•¸è¼ƒå°ï¼Œå‡ºå±€ï¼`); }
    }

    function handlePrince(meIdx) {
        let tIdx = players[meIdx].isNPC ? meIdx : prompt("é¸ä¸€ä½(åŒ…å«è‡ªå·±)ç·¨è™Ÿ:");
        let t = players[tIdx];
        addLog(`${t.name} æ£„æ‰äº† [${t.hand[0].name}] ä¸¦é‡æŠ½ã€‚`);
        if (t.hand[0].v === 8) { t.isOut = true; addLog("é‚£æ˜¯å…¬ä¸»ï¼å‡ºå±€ï¼"); }
        else { t.hand = [deck.pop()]; }
    }

    function handleKing(meIdx) {
        let tIdx = getTarget(meIdx);
        if (tIdx === null) return;
        let temp = players[meIdx].hand[0];
        players[meIdx].hand[0] = players[tIdx].hand[0];
        players[tIdx].hand[0] = temp;
        addLog(`ğŸ¤ èˆ‡ ${players[tIdx].name} äº¤æ›äº†æ‰‹ç‰Œã€‚`);
    }

    // NPC ç°¡æ˜“æ±ºç­–
    function npcAI(p) {
        // å„ªå…ˆæ‰“å‡ºä¼¯çˆµå¤«äºº
        let cIdx = p.hand.findIndex(c => c.v === 7 && p.hand.some(h => h.v >= 5));
        if (cIdx === -1) cIdx = p.hand[0].v === 8 ? 1 : 0; // é¿å…æ‰“å‡ºå…¬ä¸»
        playCard(p.id, cIdx);
    }

    // è¼”åŠ©å·¥å…·
    function getTarget(meIdx) {
        let validTargets = players.filter(p => !p.isOut && !p.isProtected && p.id !== meIdx);
        if (validTargets.length === 0) return null;
        return validTargets[0].id; // ç°¡åŒ–ç‰ˆï¼šNPC ç¸½æ˜¯é¸ç¬¬ä¸€å€‹èƒ½é¸çš„äºº
    }

    function updateUI() {
        document.getElementById('deck-count').innerText = deck.length;
        document.getElementById('direction-text').innerText = `æ–¹å‘: ${gameDir === 1 ? 'ğŸ•’ é †æ™‚é‡' : 'Counter é€†æ™‚é‡'}`;
        document.getElementById('turn-text').innerText = `è¼ªåˆ°: ${players[currentPlayer].name}`;
        
        const display = document.getElementById('players-display');
        display.innerHTML = '';
        players.forEach((p, i) => {
            let div = document.createElement('div');
            div.className = `player-box ${p.isOut ? 'is-out' : ''} ${i === currentPlayer ? 'active' : ''} ${p.isProtected ? 'protected' : ''}`;
            
            let handBtn = "";
            if (!p.isOut && !p.isNPC) {
                p.hand.forEach((c, ci) => {
                    handBtn += `<button onclick="playCard(${i}, ${ci})">${c.name} (${c.v})</button><br>`;
                });
            } else if (!p.isOut) {
                handBtn = `<p style="font-size:12px">ğŸ´ æŒæœ‰ ${p.hand.length} å¼µç‰Œ</p>`;
            }

            div.innerHTML = `<strong>${p.name}</strong><br>${handBtn}`;
            display.appendChild(div);
        });
    }

    function addLog(msg, important = false) {
        const log = document.getElementById('log');
        let div = document.createElement('div');
        div.className = `log-msg ${important ? 'log-important' : ''}`;
        div.innerHTML = `> ${msg}`;
        log.prepend(div);
    }

    function checkGameStatus() {
        let alive = players.filter(p => !p.isOut);
        if (alive.length === 1) {
            addLog(`ğŸ éŠæˆ²çµæŸï¼ç²å‹è€…æ˜¯ï¼š${alive[0].name}`, true);
            isGameOver = true;
        }
    }

    function checkWinner() {
        let alive = players.filter(p => !p.isOut);
        alive.sort((a,b) => b.hand[0].v - a.hand[0].v);
        addLog(`ğŸ ç‰Œåº«ç©ºäº†ï¼æ¯”ç‰Œç²å‹è€…ï¼š${alive[0].name}`, true);
        isGameOver = true;
    }

    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
</script>

</body>
</html>
